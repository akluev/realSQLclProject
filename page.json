{"id":"2561867784","type":"page","ari":"ari:cloud:confluence:3a66cc8f-edac-49bd-a38e-8ca71e061234:page/2561867784","base64EncodedAri":"YXJpOmNsb3VkOmNvbmZsdWVuY2U6M2E2NmNjOGYtZWRhYy00OWJkLWEzOGUtOGNhNzFlMDYxMjM0OmNvbnRlbnQvMjU2MTg2Nzc4NA==","status":"current","title":"4. Ongoing Feature Development","macroRenderedOutput":{},"body":{"storage":{"value":"<ac:structured-macro ac:name=\"toc\" ac:schema-version=\"1\" data-layout=\"default\" ac:local-id=\"1a07a230-6e0f-48ff-ac03-d849cc84ee25\" ac:macro-id=\"9b221bb8-0318-4cfd-9582-fd85be314270\"><ac:parameter ac:name=\"style\">none</ac:parameter></ac:structured-macro><h1>1. Working on A Feature ( Making Changes)  </h1><p /><h2>1.1. Git Tasks to Complete Before You Begin</h2><p /><p>Before you start making any changes to database objects make sure you create a branch in Git. The branch should  originate from the most recent  version of main branch. Run the  following commands:</p><p> </p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"49ad0e7b-7736-406b-b82b-224eae1f57b0\"><ac:plain-text-body><![CDATA[git checkout main\ngit pull\ngit checkout -b erp_fix_apexdev #Replace with your branch name]]></ac:plain-text-body></ac:structured-macro><p /><blockquote><p>Ideally branch names should be names of corresponded Jira tickets for easier Jira integratioin with Bitbucket</p></blockquote><h2>1.2. Development and Unit Testing Process</h2><p> </p><p>Proceed with development and unit testing using your favorite tool, for example, SQL Developer, SQLcl, APEX, SQL Workshop, SQL Developer Web and etc. </p><p /><h2>1.3. If New System Privileges Are Required for Application Schemas  </h2><p /><p>If new system priveleges,  roles, or table priveleges  are required, connect as super-user CLA_DEPLOYER and grant them to the schema</p><p>For example: </p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"23087021-3dcd-4cc7-9e76-3c6279857099\"><ac:plain-text-body><![CDATA[grant JAVA_ADMIN to cla_apex;\ngrant cloud_user to cla_apex\n\ngrant audit system to cla_apex;\n]]></ac:plain-text-body></ac:structured-macro><h1>2. Export and Stage Changes</h1><h2>2.1. Export Standard  Changes ( Packages, Tables and Etc.)</h2><p /><ul><li><p>Make sure you are staying in a root folder of your repository </p></li><li><p>Connect to SQLcl as CLA_DEPLOYER ( connection name <strong>proj_dev) </strong></p></li><li><p>Export all  database objects you chaged using -o  option. </p></li></ul><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"b4e8852a-a39d-4bc7-ab4f-d157953c3878\"><ac:plain-text-body><![CDATA[sql /nolog\nconn -name proj_dev\nproj export -o erp_emergency_event_util]]></ac:plain-text-body></ac:structured-macro><p /><p>Output of the command should look similar to the following:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"650bd06e-d7ed-4f31-b792-3ee74440185c\"><ac:plain-text-body><![CDATA[PS C:\\repo\\cla-project> sql /nolog\n\n\nSQLcl: Release 25.3 Production on Thu Nov 20 12:55:39 2025\n\nCopyright (c) 1982, 2025, Oracle.  All rights reserved.\n\nSQL> conn -name proj_dev\nConnected.\nSQL> proj export -o erp_emergency_event_util\nThe current connection //10.194.2.158:1521/dev.privsubnet2reg.vcnclaylacy01.oraclevcn.com CLA_DEPLOYER will be used for all operations\n*** PACKAGE_BODIES ***\n*** PACKAGE_SPECS ***\n-------------------------------\nPACKAGE_BODY                  1\nPACKAGE_SPEC                  1\n-------------------------------\nExported 2 objects\nElapsed 10 sec]]></ac:plain-text-body></ac:structured-macro><p /><blockquote><p>Note: If you use SQLcl on Windows under Git Bash, use `sql.exe //nolog` instead of `sql /nolog` </p></blockquote><h2>2.2. Export APEX Application Changes </h2><p /><p>To export changed APEX applications, use the syntax APEX.&lt;app_id&gt; in the export command, for example. </p><blockquote><p><strong><span style=\"color: rgb(191,38,0);\">Note:</span></strong> it&rsquo;s important to DELETE APEX application files in &lsquo;src&rsquo; before exporting, otherwise you may not see deleted pages and shated components  until it&rsquo;s too late&hellip;   </p></blockquote><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"3b1bd99f-fac2-4cbe-a932-480c9d120ec7\"><ac:plain-text-body><![CDATA[!rm -fR src/database/cla_apex/apex_apps/f110\n proj export -o APEX.110]]></ac:plain-text-body></ac:structured-macro><p>The output should look similar to the following:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"64b5e815-8992-4717-a8e0-d788c6f60a56\"><ac:plain-text-body><![CDATA[SQL> proj export -o APEX.110\nThe current connection //10.194.2.158:1521/dev.privsubnet2reg.vcnclaylacy01.oraclevcn.com CLA_DEPLOYER will be used for all operations\n*** APEX_APPLICATIONS ***\nExporting Workspace CLA_INTERNAL - application 110:Tactical Emergency Response Program\n-------------------------------\nAPEX_APPLICATION              1\n-------------------------------\nExported 1 objects\nElapsed 20 sec\nSQL> \n\n]]></ac:plain-text-body></ac:structured-macro><p /><p><strong>Carefully review generated files in the </strong><code>src</code><strong> folder to make sure they contain ONLY your changes and ALL your changes </strong></p><h2>2.3.<span style=\"color: rgb(255,86,48);\"> Tricky: </span>Export Changes In Grants To Application Schema</h2><p /><blockquote><p><strong><span style=\"color: rgb(255,86,48);\">Note:</span> </strong>This is a bit tricky ( actually it&rsquo;s really tricky) due to several implementation bugs in SQLcl Project. Fortunately, this task is not a part of ordinary change.   </p></blockquote><ul><li><p>Login as Schema user, i.e. CLA_APEX and NOT as CLA_DEPLOYER</p></li><li><p>Open <code>.dbtools/filters/project.filters</code> for edit and uncomment line <code>export_type  in ('USER','USER_SYS_PRIVS','USER_ROLE_PRIVS'),</code></p></li><li><p>Run &ldquo;full&rdquo; export:</p></li></ul><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"8db7e9fa-ebfe-4cf2-ba73-9d33a51fdd02\"><ac:plain-text-body><![CDATA[conn -name dev_apex\nproj export ]]></ac:plain-text-body></ac:structured-macro><ul><li><p>Export will generate files <code>src/database/sys/object_grants/user_role_privs.sql</code> and <code>src/database/sys/object_grants/user_sys_privs.sql</code> </p></li><li><p><strong><span style=\"color: rgb(255,86,48);\">Attention! When you open the files in VS Code, you will notice that new grants for the current user are added and grants for other users are REMOVED. This is a very severe bug with SQLcl Project at the time of writing.</span></strong></p></li></ul><ac:image ac:align=\"center\" ac:layout=\"center\" ac:original-height=\"461\" ac:original-width=\"1901\" ac:custom-width=\"true\" ac:alt=\"image-20251120-182426.png\" ac:width=\"760\"><ri:attachment ri:filename=\"image-20251120-182426.png\" ri:version-at-save=\"1\" /></ac:image><ul><li><p>Manually reintroduce lost changes to the files. Sometimes it&rsquo;s convenient to do in VS Code using the arrow between old and new versions, but be careful: </p></li></ul><ac:image ac:align=\"center\" ac:layout=\"center\" ac:original-height=\"459\" ac:original-width=\"332\" ac:custom-width=\"true\" ac:alt=\"image-20251120-182735.png\" ac:width=\"332\"><ri:attachment ri:filename=\"image-20251120-182735.png\" ri:version-at-save=\"1\" /></ac:image><p /><ul><li><p>Make sure that the grant files only contain your changes  </p></li></ul><ac:image ac:align=\"center\" ac:layout=\"center\" ac:original-height=\"447\" ac:original-width=\"1948\" ac:custom-width=\"true\" ac:alt=\"image-20251120-184011.png\" ac:width=\"760\"><ri:attachment ri:filename=\"image-20251120-184011.png\" ri:version-at-save=\"1\" /></ac:image><ul><li><p><strong>Revert Changes to Filters file </strong> <code>.dbtools/filters/project.filters</code> before committing in Git.</p></li></ul><h2>2.4. Stage Changes </h2><p>You are ready to stage changes when the following actions have been completed:</p><ul><li><p>All changed database objects (tables, views, triggers, constraints, packages) have been exported</p></li><li><p>All changed APEX applications  have been exported  </p></li><li><p>All changed grants and privileges have been exported  </p></li><li><p>The following changes will be added AFTER Stage command:</p><ul><li><p>Custom /DML Changes</p></li><li><p>ORDS Handlers Changes ( at least at the time of writing) </p></li></ul></li></ul><p>To do staging:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"48b0649e-2953-46d7-bc28-d6f2a0357eed\"><ac:plain-text-body><![CDATA[git add .\ngit commit -m 'ready to stage'\nsql /nolog\nconn -name proj_dev\nproj stage ]]></ac:plain-text-body></ac:structured-macro><p /><p>Output on the process will look like the following. Please note the warnings &ldquo;<strong>The hash value of the file user_role_privs.sql was incorrect and has been automatically adjusted</strong>&rdquo; . This is a result of our manual adjsutment of these files. It&rsquo;s expected</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"269fec91-c9cc-412f-a906-133b196b99a8\"><ac:plain-text-body><![CDATA[SQL> proj stage\n\nStage is Comparing:\nOld Branch      refs/heads/main\nNew Branch      refs/heads/erp_fix_apexdev\n\nWARN: The following files were updated:\nThe hash value of the file user_role_privs.sql was incorrect and has been automatically adjusted\nThe hash value of the file user_sys_privs.sql was incorrect and has been automatically adjusted\n\n\n\n\nStage processesing completed, please review and commit your changes to repository]]></ac:plain-text-body></ac:structured-macro><p>All information below &ldquo;<strong>Stage processesing completed</strong>&rdquo; line is pretty much useless. </p><p> Review the changes in VS Code. Verify that you only have the changes that you made. </p><blockquote><p>Note: You may note changes to &ldquo;ORDS&rdquo; that you did not make. <strong><span style=\"color: rgb(255,86,48);\">This is another bug with SQLcl . </span></strong> You should get rid of these changes either by pressing &ldquo;Disacard&rdquo; button in VS Code or running Git Command </p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"621ea2a3-38f7-4a11-ad2b-a82d8bbc970c\"><ac:plain-text-body><![CDATA[git restore --source=main --worktree --staged -- dist/releases/ords]]></ac:plain-text-body></ac:structured-macro></blockquote><ac:image ac:align=\"center\" ac:layout=\"center\" ac:original-height=\"531\" ac:original-width=\"426\" ac:custom-width=\"true\" ac:alt=\"image-20251120-194322.png\" ac:width=\"426\"><ri:attachment ri:filename=\"image-20251120-194322.png\" ri:version-at-save=\"1\" /></ac:image><p /><p /><blockquote><p><strong>Note: </strong> If you find it more convinient, you may run git commands from SQLcl using <strong>!</strong> syntax. However, in this case run <code>pwd</code> first to verify that SQLcl is in repo root folder</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"39351dcd-3546-4727-9b50-c1b61b4bd1cd\"><ac:plain-text-body><![CDATA[pwd\n!git add.\n]]></ac:plain-text-body></ac:structured-macro></blockquote><h2>2.5. Add  DML and Other Custom Changes</h2><p /><p>If you need to add DML or any other custom files to your feature, it&rsquo;s time to do it now with &lsquo;stage add-custom&rsquo; command.</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"4fe46c44-d10c-48a7-a70b-156bf90f7a00\"><ac:plain-text-body><![CDATA[ proj stage add-custom -file-name  test.sql]]></ac:plain-text-body></ac:structured-macro><p>The most common custom changes:</p><ol start=\"1\"><li><p>DML on &ldquo;fixed&rdquo; tables, for example,  insert 15 invoice statuses into INVOICE_STATUS table</p></li><li><p>Handle objects that SQLcl project does not handle natively, for example:</p><ol start=\"1\"><li><p>Run Alter System</p></li><li><p> Create/Drop APEX Workspace</p></li><li><p>Create/Drop Scheduled Jobs, AQ Tables, Refresh Materialized Views</p></li><li><p>Stop/Start Jobs and APEX Automations</p></li><li><p>&hellip; and much more&hellip;</p></li></ol></li></ol><p /><p>After running add-custom command above, open the file <code>dist/releases/next/changes/&lt;your_branch&gt;/_custom/test.sql</code>  for edit and add your code after LB header, so  for example it looks like this:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"969a5f87-7ecc-4d57-99cf-fb8a53235ff5\"><ac:plain-text-body><![CDATA[-- liquibase formatted sql\n-- changeset  SqlCl:1763669390933 stripComments:false logicalFilePath:erp_fix_apexdev\\_custom\\test.sql\n-- sqlcl_snapshot dist\\releases\\next\\changes\\erp_fix_apexdev\\_custom\\test.sql:null:null:custom\n\n\n\nPrompt \"Testing...\"\n\nbegin\n    null;\n end;\n/\n]]></ac:plain-text-body></ac:structured-macro><h2>2.7. <span style=\"color: rgb(255,86,48);\">Tricky</span>:Add ORDS Changes</h2><p /><p>SQLcl provides built-in inetrface to manage ORDs schema, <strong>however this interface lacks granularity and deals with the entire schema. </strong></p><p>In reality, developers usually make changes to a module, test it  and want to deploy this module only to production. Your development environment may include other multiple modules which are in WIP or POC state, so deploying the entire schema is very rare an option...</p><p>To incorporate deployment of ORDS module changes into your feature, follow the procedure and example available in the file <code>scripts/sql/deployment/deploy_ords_module.sql</code>:</p><p /><ol start=\"1\"><li><p>Create a custom script to export ORDS module definition</p></li></ol><p /><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"425fca9f-3fdf-4fda-93c9-d3ece2b2fbcb\"><ac:plain-text-body><![CDATA[proj stage add-custom -file-name ord_tracerp_module -- replace by your module name]]></ac:plain-text-body></ac:structured-macro><ol start=\"2\"><li><p>Run the script below as schema owner CLA_APEX or CLA_PUBLIC (NOT as CLA_DEPLOYER!!!!) to export ORDS module definition </p></li></ol><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"e437e5ad-87b8-4c31-b71c-f4e6b8db1955\"><ac:plain-text-body><![CDATA[SELECT \n REGEXP_REPLACE(\n ords_metadata.ords_export.export_module (\n        p_module_name             => u.name,\n        p_include_enable_schema   => false ,\n        p_include_privs           => true ,\n        p_privs_with_other_mod_refs   => true,\n        p_export_date             => false\n    ),\n     'ORDS\\.([^\\(]*\\()',\n      'ORDS_ADMIN.\\1\n      p_schema => '''||user||''', ',\n               1, 0, 'n'\n    )||'\n/\n' stmt\n  FROM USER_ORDS_MODULES u\n  where u.name = 'claylacy.tacerp' --- specify your module name here\n/\n]]></ac:plain-text-body></ac:structured-macro><ol start=\"3\"><li><p>APPEND the output to the file created in step 1</p></li></ol><p>  </p><h2>2.9. Split Statements in  DDL File </h2><p /><p><strong>Another limitation of SQLcl is that it does not split ALTER TABLE and other table-related statements in a changeset file. </strong></p><p>For, example, if  you have multiple changes in CLA_AIRCRAFT table,  you file <code>dist/releases/next/changes/dev-02/cla_apex/tables/cla_aircraft.sql </code></p><p>will look like this:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"35c768e5-408d-4a17-81bc-6e620990e96b\"><ac:plain-text-body><![CDATA[\n -- liquibase formatted sql \n-- sqlcl_snapshot src/database/cla_apex/tables/cla_aircraft.sql:08bee489420289da19c387e5b924e0e21acc0faa:f6b3abb88fff315ad9e845989ec24ed6b54d31a3:alter \n-- changeset CLA_APEX:1761764378736 stripComments:false logicalFilePath:dev-02\\cla_apex\\tables\\cla_aircraft.sql \n\nalter table cla_apex.cla_aircraft \ndrop (fl3xx_live); \n\nalter table cla_apex.cla_aircraft add ( \nadult_critical_care number(1, 0), \naviapages_aircraft_id number, \naviapages_aircraft_type_id number, \nyear_of_production number \n); \n\nalter table cla_apex.cla_aircraft \nadd constraint make_model_serial_uk2 unique (aviapages_aircraft_type_id, serial_number) \nusing index enable; \n\nalter table cla_apex.cla_aircraft \nadd constraint registration_uk1 unique (registration) \nusing index enable;]]></ac:plain-text-body></ac:structured-macro><p>This file should be manually edited to move each DDL statement in its own changeset, the resulting file should look like the following:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"fc6f55d8-3ad5-43cc-8121-cab7d0de8aa1\"><ac:plain-text-body><![CDATA[-- liquibase formatted sql \n-- sqlcl_snapshot src/database/cla_apex/tables/cla_aircraft.sql:08bee489420289da19c387e5b924e0e21acc0faa:f6b3abb88fff315ad9e845989ec24ed6b54d31a3:alter \n\n-- changeset CLA_APEX:1761764378736.1 stripComments:false logicalFilePath:dev-02\\cla_apex\\tables\\cla_aircraft.sql \nalter table cla_apex.cla_aircraft \ndrop (fl3xx_live); \n\n-- changeset CLA_APEX:1761764378736.2 stripComments:false logicalFilePath:dev-02\\cla_apex\\tables\\cla_aircraft.sql \nalter table cla_apex.cla_aircraft add ( \nadult_critical_care number(1, 0), \naviapages_aircraft_id number, \naviapages_aircraft_type_id number, \nyear_of_production number \n); \n\n-- changeset CLA_APEX:1761764378736.3 stripComments:false logicalFilePath:dev-02\\cla_apex\\tables\\cla_aircraft.sql \nalter table cla_apex.cla_aircraft \nadd constraint make_model_serial_uk2 unique (aviapages_aircraft_type_id, serial_number) \nusing index enable; \n\n-- changeset CLA_APEX:1761764378736.4 stripComments:false logicalFilePath:dev-02\\cla_apex\\tables\\cla_aircraft.sql \nalter table cla_apex.cla_aircraft \nadd constraint registration_uk1 unique (registration) \nusing index enable; ]]></ac:plain-text-body></ac:structured-macro><p> I.e. one line </p><p><strong>-- changeset CLA_APEX:1761764378736 stripComments:false logicalFilePath:dev-02\\cla_apex\\tables\\cla_aircraft.sql </strong></p><p>is replaced by four lines </p><p><strong>-- changeset CLA_APEX:1761764378736.<span style=\"color: rgb(191,38,0);\">[1-4]</span> stripComments:false logicalFilePath:dev-02\\cla_apex\\tables\\cla_aircraft.sql </strong></p><p>That allows the installation process to become restartable regradless at what statement the process fails   </p><h2><br />2.8. <span style=\"color: rgb(191,38,0);\">Tricky:</span> Re-Staging </h2><p /><p>If you discovered that you need to do some changes to SRC ( for example, if you forgot to include an object, you need to change the package, or last minute in changing grands) you will have to do re-staging. <strong>Unfortunately,  SQLcl Project does a terrible job with incremental staging and re-staging. </strong></p><p>There are two situations:</p><ol start=\"1\"><li><p><strong>You did not do too many manual changes to your feature in DIST</strong></p></li></ol><p style=\"margin-left: 30.0px;\">In this case, the best option would be discarding chages under <code>dist</code> in Git and do <code>project stage</code> </p><p>For example, we granted above two new priveleges to CLA_APEX - Turns out it was a mistake. Now the privileges have been  revoked in DEV and we need to update our feature branch:</p><ul><li><p>Fist, we restore grants files from main:</p></li></ul><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"4fac09fc-b446-4cb8-a95e-b61ee1b52de5\"><ac:plain-text-body><![CDATA[git restore --source=main --worktree --staged src/database/sys/object_grants/user_role_privs.sql\ngit restore --source=main --worktree --staged src/database/sys/object_grants/user_sys_privs.sql]]></ac:plain-text-body></ac:structured-macro><ul><li><p>Now we fully discard changes in <code>dist</code> </p></li></ul><blockquote><p>Notes: You may find more convinient to go it with VS Code Discard button </p></blockquote><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"97f93d40-e99c-4132-9524-7da2336d4380\"><ac:plain-text-body><![CDATA[git restore --source=main --worktree --staged dist/releases/\ngit restore --staged dist/releases/\ngit clean -fd dist/releases/]]></ac:plain-text-body></ac:structured-macro><ul><li><p>Now commit the reverted changes in SRC and stage again</p></li></ul><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"c76c5ebc-16cb-4895-be8b-91650c09d7e8\"><ac:plain-text-body><![CDATA[!git commit -m 'removed wrong  grants'\nconn -name proj_dev\nproj stage\n]]></ac:plain-text-body></ac:structured-macro><ul><li><p>As annoying as it is,  fake ORDS changes are generated and need to be removed</p></li></ul><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"f9234a7e-ae51-47ab-9c29-1c0ea710a21f\"><ac:plain-text-body><![CDATA[ git restore --source=main --worktree --staged -- dist/releases/ords]]></ac:plain-text-body></ac:structured-macro><p>Now you have a clean updated dist folder which is ready for deployment </p><p /><ac:image ac:align=\"center\" ac:layout=\"center\" ac:original-height=\"415\" ac:original-width=\"1572\" ac:custom-width=\"true\" ac:alt=\"image-20251121-191313.png\" ac:width=\"760\"><ri:attachment ri:filename=\"image-20251121-191313.png\" ri:version-at-save=\"1\" /></ac:image><p /><p /><ol start=\"2\"><li><p><strong>You did sizable changes in DIST Folder</strong></p></li></ol><p>Unfortunately, SQLcl Project does not do a good job here. If you want to re-stage after you have made significant changes, you need to follow these steps:</p><p /><ul><li><p>Commit or at least stage in Git your current changes, so you can easily see the difference re-staging will introduce</p></li></ul><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"3f0db90f-51f3-4a35-8d3a-7fc18e23a102\"><ac:plain-text-body><![CDATA[git add dist/\n# Optionally\ngit commit -m \"before re-staging\"]]></ac:plain-text-body></ac:structured-macro><p /><ul><li><p>Run stage command again</p></li></ul><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"1cf0fc91-b5d6-4879-8975-265a5457c18c\"><ac:plain-text-body><![CDATA[project stage]]></ac:plain-text-body></ac:structured-macro><ul><li><p>  In VS Code in Changes <strong><span style=\"color: rgb(255,86,48);\">very careful review all changed files and make case-by-case decision if you wan to:</span></strong></p><ul><li><p>Accept new changes</p></li><li><p>Discard new changes</p></li><li><p>Merge changes</p></li></ul></li><li><p>One of the files wich <strong>always be</strong> changed at re-staging is <code>dist/releases/next/changes/&lt;feature&gt;/stage.changelog.xml</code> <strong>Always open this file in VS Code Changes view and analyse the differences.</strong></p></li></ul><p> </p><ac:image ac:align=\"center\" ac:layout=\"center\" ac:original-height=\"266\" ac:original-width=\"2031\" ac:custom-width=\"true\" ac:alt=\"image-20251121-192837.png\" ac:width=\"760\"><ri:attachment ri:filename=\"image-20251121-192837.png\" ri:version-at-save=\"1\" /></ac:image><p /><p /><p>As you can see, in this example <code>project stage</code> just added the same files to this file twice. In this case, the changes to this file can simply be discarded; however, more often you would need to merge old and new changes in this file manually.  </p><h1>3. Test Deployment Scripts</h1><p /><p>To test deployment scripts you need to run them against VM database. </p><ul><li><p>You can discover multiple issues during deployment and may need to rerun it several times.  </p></li><li><p>If you ran into a problem you can fix it and continue. However, to verify your fix you should restore  VM to a restore point and try to run entire script error free. </p></li><li><p>Use Helper script <code>dist/install_vm.sql</code>  to try your deployment on VM </p></li></ul><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"362afb29-e0fc-42f1-8fce-bb1f9d818f47\"><ac:plain-text-body><![CDATA[cd . \nconn -name proj_vm\n\n prompt \"Dropping restore point before installation if exists\"\nbegin\n    execute immediate 'drop restore point before_installation';\nexception\n    when others then\n        if sqlcode != -1918 then\n            raise;\n        end if;\nend;\n/\n\nprompt \"Creating restore point before installation\"\ncreate restore point before_installation;\n\n@install ]]></ac:plain-text-body></ac:structured-macro><ul><li><p>To run the script,  make sure  you start from dist folder:</p></li></ul><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"22f3d0d9-25e2-4f54-8a5e-ee4c09383b36\"><ac:plain-text-body><![CDATA[cd dist\n@dist/install_vm.sql]]></ac:plain-text-body></ac:structured-macro><ul><li><p>If you have any erorrs, run the script <code>@install.sql</code> not <code>install_vm.sql</code>until you have a clean run install.</p></li><li><p>If possible,  connect to VM in SQL Developer, review and unit test your changes. </p></li></ul><p><strong>When you are done with testing, reset VM to the restore point.Run </strong><code>scripts\\sql\\deployment\\vm_flashback.sql</code></p><p /><p><strong>At this point you tested your deployment against the VM database and reset the VM to he state of the main branch. </strong></p><h1>4. Submit and Merge PR </h1><p /><h2>4.1. Submit PR </h2><p>Now, you know that your code is deployable, it&rsquo;s time to submit a PR and get reviewed and it approved by your peers!</p><p>To submit a PR:</p><p /><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"b47eaf6e-c0c4-450d-a837-732cfde78eea\"><ac:plain-text-body><![CDATA[git add .\ngit commit -m 'ready for review'\ngit push --set-upstream origin erp_fix_apexdev #replace with your branch name\n]]></ac:plain-text-body></ac:structured-macro><p>Bitbucket will create a pull request for you and send you back a URL. Follow the URL:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"95a2e322-399e-407a-ab4a-049adc71d9a9\"><ac:plain-text-body><![CDATA[git push --set-upstream origin erp_fix_apexdev\nEnumerating objects: 77, done.\nCounting objects: 100% (77/77), done.\nDelta compression using up to 16 threads\nCompressing objects: 100% (43/43), done.\nWriting objects: 100% (49/49), 32.48 KiB | 665.00 KiB/s, done.\nTotal 49 (delta 26), reused 0 (delta 0), pack-reused 0 (from 0)\nremote: \nremote: Create pull request for erp_fix_apexdev:\nremote:   https://bitbucket.org/cla-apex/cla-project/pull-requests/new?source=erp_fix_apexdev&t=1\nremote:\nTo bitbucket.org:cla-apex/cla-project.git\n * [new branch]      erp_fix_apexdev -> erp_fix_apexdev\nbranch 'erp_fix_apexdev' set up to track 'origin/erp_fix_apexdev'.]]></ac:plain-text-body></ac:structured-macro><p /><p>In this case the url to follow was <a href=\"https://bitbucket.org/cla-apex/cla-project/pull-requests/new?source=erp_fix_apexdev&amp;t=1\">https://bitbucket.org/cla-apex/cla-project/pull-requests/new?source=erp_fix_apexdev&amp;t=1</a></p><blockquote><p><strong>Carefully review all the changes in bitbucket, make sure you understand every change. When done with the review:</strong></p><ol start=\"1\"><li><p><strong>Click &ldquo;Create pull request&rdquo; buton</strong></p></li><li><p>Assing the  reviewer</p></li></ol><p /></blockquote><ac:image ac:align=\"center\" ac:layout=\"center\" ac:original-height=\"825\" ac:original-width=\"1647\" ac:custom-width=\"true\" ac:alt=\"image-20251121-201433.png\" ac:width=\"760\"><ri:attachment ri:filename=\"image-20251121-201433.png\" ri:version-at-save=\"1\" /></ac:image><p /><h2>4.2. Approve  and Merge PR </h2><p /><p>Work with the reviewer to make sure the feature is approved and merged. To merge  PR open it and click Merge button. </p><ac:image ac:align=\"center\" ac:layout=\"center\" ac:original-height=\"673\" ac:original-width=\"1667\" ac:custom-width=\"true\" ac:alt=\"image-20251121-202523.png\" ac:width=\"760\"><ri:attachment ri:filename=\"image-20251121-202523.png\" ri:version-at-save=\"1\" /></ac:image><p /><h2>4.3. Pull Main Branch</h2><p /><p>After PR is approved,  it&rsquo;s  critical to switch branch to main and pull main before proceeding to all steps below </p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"aff7b38b-0232-4534-b893-8418a94b3c8d\"><ac:plain-text-body><![CDATA[git checkout main \ngit pull]]></ac:plain-text-body></ac:structured-macro><h1>5. <span style=\"color: rgb(255,86,48);\">Optional: </span>Build Deployment Articact</h1><p> </p><p>After the feature is merged, it&rsquo;s ready to be deployed to TEST. </p><p><strong><u>Optionally </u></strong>you can build an artifact to support the deployment. </p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"ab016077-9fe9-4650-9428-da2afbf05a70\"><ac:plain-text-body><![CDATA[project gen-artifact -name erp_fix_apexdev  -version 25.3  -format zip -verbose]]></ac:plain-text-body></ac:structured-macro><p>successfull command  output will look the followinfg:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"40a18cd8-a94f-4eb7-b376-ed616f9a7c74\"><ac:plain-text-body><![CDATA[...\n\nile : C:\\repo\\cla-project\\dist\\sqlcl-lb-1763754424655.log\nfile : C:\\repo\\cla-project\\dist\\sqlcl-lb-1763754930069.log\nfile : C:\\repo\\cla-project\\dist\\utils\\enable_automations.sql\nfile : C:\\repo\\cla-project\\dist\\utils\\prechecks.sql\nfile : C:\\repo\\cla-project\\dist\\utils\\recompile.sql\nYour artifact has been generated erp_fix_apexdev-25.3.zip]]></ac:plain-text-body></ac:structured-macro><p /><blockquote><p><strong>Note</strong>: Building atrifact is mandatory if deployment to Test is carried out by a DBA or CI/CD Pipeline process. </p><p>In case the deployment  is carried out by developer, the articact is not required.</p></blockquote><p /><h1>6. Deploy to Test </h1><p /><h2>6.1. Deployment By Developer  ( No Artifact) </h2><p /><p>To deployment to test by the developer, it&rsquo;s enoug to run the following command in SQLcl:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"ad0d17f4-c246-4591-8022-ef6361abd523\"><ac:plain-text-body><![CDATA[conn -name proj_test\nshow conn --- Verify  \npwd -- Veriy if current floder is dist. If not:\ncd dist  \n@install]]></ac:plain-text-body></ac:structured-macro><p>During the deployment a log file <code>dist/sqlcl-lb-&lt;some-id&gt;log</code> will be generated and can be reviewed later for troubleshooting. </p><h2>6.2. Deployment With Artifact </h2><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"39bc8308-74dd-43fd-b880-9e4044581417\"><ac:plain-text-body><![CDATA[conn -name proj_test\nproject deploy -file artifact/erp_fix_apexdev-25.3.zip -verbose\n]]></ac:plain-text-body></ac:structured-macro><p /><blockquote><p><strong>Note: </strong>If artifact has nothing to do, it fails with ugly Java error:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"b607baf9-07be-4d03-a93a-94604495d4ba\"><ac:plain-text-body><![CDATA[tarting the migration...\nInstalling/updating schemas\n--Starting Liquibase at 2025-11-21T16:06:36.141710600 using Java 17.0.13 (version 4.30.0 #0 built at 2025-04-01 10:24+0000)\nRunning Changeset: dev-01/_custom/ams_config_dml.sql::1761249915279::SqlCl\n\nUPDATE SUMMARY\nRun:                          1\nPreviously run:            2572\nFiltered out:                 0\n-------------------------------\nTotal change sets:         2573\n\nLiquibase: Update has been successful. Rows affected: 0\n\nNull Pointer please log a bug.\njava.lang.NullPointerException: Cannot invoke \"java.io.File.getName()\" because the return value of \"oracle.dbtools.raptor.liquibase.util.LbFileUtils.getLog()\" is null\n        at oracle.dbtools.raptor.scriptrunner.commands.liquibase.LbCommand.write_success(LbCommand.java:475)\n        at oracle.dbtools.raptor.scriptrunner.commands.liquibase.LbCommand.handleEvent(LbCommand.java:382)\n        at oracle.dbtools.raptor.newscriptrunner.CommandRegistry.fireListeners(CommandRegistry.java:454)\n        at oracle.dbtools.raptor.newscriptrunner.ScriptRunner.lambda$run$0(ScriptRunner.java:241)\n        at oracle.dbtools.raptor.newscriptrunner.ScriptRunnerContext.runWithStoredContext(ScriptRunnerContext.java:837) ]]></ac:plain-text-body></ac:structured-macro></blockquote><h1>7. Conduct UAT</h1><p /><p>Well, this is up to the cleint  <ac:emoticon ac:name=\"smile\" ac:emoji-shortname=\":slight_smile:\" ac:emoji-id=\"1f642\" ac:emoji-fallback=\"\uD83D\uDE42\" /> </p><p><strong>Important:  </strong>If issues are found during UAT testing, at your discreptrion: </p><ul><li><p>You can start a new branch in Git ( <strong>Highly recommended in most cases !!!!) </strong></p></li><li><p>Check out current feature branch and continue to working( Only recommended for small changes like adding a custom file or rebuilding a package) </p></li></ul><p /><p>In either afer a UAT fix is apprived and tested in TEST, merge changes to main.</p><p>If you have fixed UAT issue in test, please backfill Dev ( see <ac:link><ri:page ri:content-title=\"5. Hot Fix Deployment\" ri:version-at-save=\"1\" /><ac:link-body>https://claviation.atlassian.net/wiki/spaces/OA/pages/2562097153/5.+Hot+Fix+Deployment</ac:link-body></ac:link> for details )</p><p> </p><h1>8. Build a Release</h1><ul><li><p>Release is built when all changes that need to go to Prod have passed UAT in Test</p></li><li><p>There are NO changes in Test ( and merged into the main branch that are currently undergoing testing) </p></li></ul><p>To build a release ( Replace 25.3. by your release number): </p><p /><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"8c2abc9b-a48e-4927-bf70-058077276be1\"><ac:plain-text-body><![CDATA[conn -name proj_test --- Can be also dev, prod, or vm, goes not matter \ngit checkout main\ngit pull\n--- you can build release in main to save time, it's OK...\n\nproj release -version 25.3 -v\n\ngit add .\ngit commit -m 'release 25.3'\ngit tag  25.3\ngit push]]></ac:plain-text-body></ac:structured-macro><p /><h1>9. Deploy to Prod</h1><h2>9.1. Avoid Surprises</h2><p>To avoid any surprises, what   would be run in Production, before proceeding with a real update, <strong>always </strong>run <code>LB STATUS</code>:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"bc40b6ab-f803-4b33-8fc7-1cc9d9f4825a\"><ac:plain-text-body><![CDATA[conn -name proj_prod\nlb status  -changelog-file releases/main.changelog.xml]]></ac:plain-text-body></ac:structured-macro><p /><p>It produces the following output:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"cf3cf65e-2bd6-416b-9e50-00f210baa063\"><ac:plain-text-body><![CDATA[SQL> lb status  -changelog-file releases/main.changelog.xml\n--Starting Liquibase at 2025-11-21T16:38:05.487693200 using Java 17.0.13 (version 4.30.0 #0 built at 2025-04-01 10:24+0000)\n4 changesets have not been applied to CLA_DEPLOYER@jdbc:oracle:thin:@//10.194.2.167:1521/pdb01.privsubnet2reg.vcnclaylacy01.oraclevcn.com\n     dev-01/_custom/ams_config_dml.sql::1761249915279::SqlCl\n     erp_fix_apexdev/cla_apex/package_specs/erp_emergency_event_util.sql::1763752587080::CLA_APEX\n     erp_fix_apexdev/cla_apex/package_bodies/erp_emergency_event_util.sql::1763752586636::CLA_APEX\n     releases/apex/f110/f110.xml::INSTALL_110::SQLCL-Generated\n\n\nOperation completed successfully.]]></ac:plain-text-body></ac:structured-macro><p /><p>Make sure you recognize all changes ( and the most important - all APEX apps that are going to be deployed)  </p><h2>9.2. Identify Production Drift </h2><p /><p>Follow <a href=\"https://claviation.atlassian.net/wiki/spaces/OA/pages/2561638402/6.+Mitigating+Production+Drift?atlOrigin=eyJpIjoiZDljMjc4OTEzNWE0NDgyMmIyOTdiYTc0OGNlMGY5OTUiLCJwIjoiYyJ9\">https://claviation.atlassian.net/wiki/spaces/OA/pages/2561638402/6.+Mitigating+Production+Drift?atlOrigin=eyJpIjoiZDljMjc4OTEzNWE0NDgyMmIyOTdiYTc0OGNlMGY5OTUiLCJwIjoiYyJ9</a> to identify any drift in objects you are about to deploy </p><h2>9.3. GO!</h2><p>Follow the same procedures as for <a href=\"https://claviation.atlassian.net/wiki/spaces/OA/pages/edit-v2/2561867784#6.-Deploy-to-Test\">https://claviation.atlassian.net/wiki/spaces/OA/pages/edit-v2/2561867784#6.-Deploy-to-Test</a></p><p /><h1>10.  Taking Care of  Unexpected </h1><p /><p>Even a perfectly tested deployment sometimes fails in Production.  There are two strategies to deal with  that:</p><p /><ol start=\"1\"><li><p>If your system supports it, incorporate into your deployment ( or run before your deployment) a  <code>CREATE RESTORE POINT</code> command:</p></li></ol><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"2e2bff65-6f3a-4d54-80f9-0b693dc55454\"><ac:plain-text-body><![CDATA[create restore point before_installation;]]></ac:plain-text-body></ac:structured-macro><p>If deployment fails, you may ask a DBA to flashback your database ot this restore point:</p><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"d7dc6a47-bd0f-4ff1-81d4-67f3a144288e\"><ac:plain-text-body><![CDATA[FLASHBACK PLUGGABLE DATABASE FREEPDB1 TO RESTORE POINT TEST]]></ac:plain-text-body></ac:structured-macro><p /><blockquote><p>Note: Fleashback Pluggable Database  feature is not supported in Oracle Standard</p></blockquote><ol start=\"2\"><li><p> If you do not have the flashback option, you will need to finish deployment, otherwise your system will be in an inconsistent state.  </p></li></ol><p /><ul><li><p>In case of changeset failing, investigate and eliminate the root cause. For example, if you fail to create a unique constratint, delete duplicate records and rerun the installation </p></li><li><p>In you are trying to create a unique constraint that already exists, run the following command to mark the last failed changeset as &ldquo;RUN&rdquo; and proceed with installation.</p></li></ul><ac:structured-macro ac:name=\"code\" ac:schema-version=\"1\" ac:macro-id=\"86d044d0-ba01-4f7b-8acb-99a6a6ed5077\"><ac:plain-text-body><![CDATA[liquibase mark-next-changeset-ran -changelog-file releases/main.changelog.xml ]]></ac:plain-text-body></ac:structured-macro><p /><h1> </h1><h1> </h1><p /><h2> </h2><p />","representation":"storage","embeddedContent":[],"_expandable":{"content":"/rest/api/content/2561867784"}},"_expandable":{"editor":"","atlas_doc_format":"","view":"","export_view":"","styled_view":"","dynamic":"","editor2":"","anonymous_export_view":""}},"extensions":{"position":335213801},"_expandable":{"container":"/rest/api/space/OA","metadata":"","restrictions":"/rest/api/content/2561867784/restriction/byOperation","history":"/rest/api/content/2561867784/history","version":"","descendants":"/rest/api/content/2561867784/descendant","space":"/rest/api/space/OA","childTypes":"","schedulePublishInfo":"","operations":"","schedulePublishDate":"","children":"/rest/api/content/2561867784/child","ancestors":"","draftVersion":""},"_links":{"editui":"/pages/resumedraft.action?draftId=2561867784","webui":"/spaces/OA/pages/2561867784/4.+Ongoing+Feature+Development","edituiv2":"/spaces/OA/pages/edit-v2/2561867784","context":"/wiki","self":"https://claviation.atlassian.net/wiki/rest/api/content/2561867784","tinyui":"/x/CACzm","collection":"/rest/api/content","base":"https://claviation.atlassian.net/wiki"}}