<div class="toc-macro client-side-toc-macro conf-macro output-block" cssliststyle="none" hasbody="false" headerelements="H1,H2,H3,H4,H5,H6,H7" layout="default" local-id="1a07a230-6e0f-48ff-ac03-d849cc84ee25" macro-id="9b221bb8-0318-4cfd-9582-fd85be314270" macro-name="toc">

</div>

# 1. Working on A Feature ( Making Changes)

## 1.1. Git Tasks to Complete Before You Begin

Before you start making any changes to database objects make sure you create a branch in Git. The branch should originate from the most recent version of main branch. Run the following commands:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="49ad0e7b-7736-406b-b82b-224eae1f57b0" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
git checkout main
git pull
git checkout -b erp_fix_apexdev #Replace with your branch name
```

</div>

</div>

> Ideally branch names should be names of corresponded Jira tickets for easier Jira integratioin with Bitbucket

## 1.2. Development and Unit Testing Process

Proceed with development and unit testing using your favorite tool, for example, SQL Developer, SQLcl, APEX, SQL Workshop, SQL Developer Web and etc.

## 1.3. If New System Privileges Are Required for Application Schemas

If new system priveleges, roles, or table priveleges are required, connect as super-user CLA_DEPLOYER and grant them to the schema

For example:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="23087021-3dcd-4cc7-9e76-3c6279857099" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
grant JAVA_ADMIN to cla_apex;
grant cloud_user to cla_apex

grant audit system to cla_apex;
```

</div>

</div>

# 2. Export and Stage Changes

## 2.1. Export Standard Changes ( Packages, Tables and Etc.)

- Make sure you are staying in a root folder of your repository

- Connect to SQLcl as CLA_DEPLOYER ( connection name **proj_dev)**

- Export all database objects you chaged using -o option.

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="b4e8852a-a39d-4bc7-ab4f-d157953c3878" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
sql /nolog
conn -name proj_dev
proj export -o erp_emergency_event_util
```

</div>

</div>

Output of the command should look similar to the following:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="650bd06e-d7ed-4f31-b792-3ee74440185c" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
PS C:\repo\cla-project> sql /nolog


SQLcl: Release 25.3 Production on Thu Nov 20 12:55:39 2025

Copyright (c) 1982, 2025, Oracle.  All rights reserved.

SQL> conn -name proj_dev
Connected.
SQL> proj export -o erp_emergency_event_util
The current connection //10.194.2.158:1521/dev.privsubnet2reg.vcnclaylacy01.oraclevcn.com CLA_DEPLOYER will be used for all operations
*** PACKAGE_BODIES ***
*** PACKAGE_SPECS ***
-------------------------------
PACKAGE_BODY                  1
PACKAGE_SPEC                  1
-------------------------------
Exported 2 objects
Elapsed 10 sec
```

</div>

</div>

> Note: If you use SQLcl on Windows under Git Bash, use \`sql.exe //nolog\` instead of \`sql /nolog\`

## 2.2. Export APEX Application Changes

To export changed APEX applications, use the syntax APEX.\<app_id\> in the export command, for example.

> **<span colorid="qmwqla90zf">Note:</span>** it‚Äôs important to DELETE APEX application files in ‚Äòsrc‚Äô before exporting, otherwise you may not see deleted pages and shated components until it‚Äôs too late‚Ä¶

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="3b1bd99f-fac2-4cbe-a932-480c9d120ec7" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
!rm -fR src/database/cla_apex/apex_apps/f110
 proj export -o APEX.110
```

</div>

</div>

The output should look similar to the following:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="64b5e815-8992-4717-a8e0-d788c6f60a56" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
SQL> proj export -o APEX.110
The current connection //10.194.2.158:1521/dev.privsubnet2reg.vcnclaylacy01.oraclevcn.com CLA_DEPLOYER will be used for all operations
*** APEX_APPLICATIONS ***
Exporting Workspace CLA_INTERNAL - application 110:Tactical Emergency Response Program
-------------------------------
APEX_APPLICATION              1
-------------------------------
Exported 1 objects
Elapsed 20 sec
SQL> 
```

</div>

</div>

**Carefully review generated files in the** `src` **folder to make sure they contain ONLY your changes and ALL your changes**

## 2.3.<span colorid="xfb24yiezh"> Tricky: </span>Export Changes In Grants To Application Schema

> **<span colorid="mb4z3u5q86">Note:</span>** This is a bit tricky ( actually it‚Äôs really tricky) due to several implementation bugs in SQLcl Project. Fortunately, this task is not a part of ordinary change.

- Login as Schema user, i.e. CLA_APEX and NOT as CLA_DEPLOYER

- Open `.dbtools/filters/project.filters` for edit and uncomment line `export_type in ('USER','USER_SYS_PRIVS','USER_ROLE_PRIVS'),`

- Run ‚Äúfull‚Äù export:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="8db7e9fa-ebfe-4cf2-ba73-9d33a51fdd02" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
conn -name dev_apex
proj export 
```

</div>

</div>

- Export will generate files `src/database/sys/object_grants/user_role_privs.sql` and `src/database/sys/object_grants/user_sys_privs.sql`

- **<span colorid="wgajcaxnox">Attention! When you open the files in VS Code, you will notice that new grants for the current user are added and grants for other users are REMOVED. This is a very severe bug with SQLcl Project at the time of writing.</span>**

<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img src="images/image-20251120-182426.png" class="confluence-embedded-image image-center" loading="lazy" data-image-src="images/image-20251120-182426.png" data-height="461" data-width="1901" data-unresolved-comment-count="0" data-linked-resource-id="2562916357" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20251120-182426.png" data-base-url="https://claviation.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="2561867784" data-linked-resource-container-version="9" data-media-id="de2756c7-f15d-484c-98c4-91039ea42352" data-media-type="file" srcset="images/image-20251120-182426.png 2x, images/image-20251120-182426.png 1x" width="760" alt="image-20251120-182426.png" /></span>

- Manually reintroduce lost changes to the files. Sometimes it‚Äôs convenient to do in VS Code using the arrow between old and new versions, but be careful:

<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img src="images/image-20251120-182735.png" class="confluence-embedded-image image-center" loading="lazy" data-image-src="images/image-20251120-182735.png" data-height="459" data-width="332" data-unresolved-comment-count="0" data-linked-resource-id="2563375107" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20251120-182735.png" data-base-url="https://claviation.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="2561867784" data-linked-resource-container-version="9" data-media-id="5b1eae45-c195-4c41-b8bd-83dea8d533a0" data-media-type="file" srcset="images/image-20251120-182735.png 2x, images/image-20251120-182735.png 1x" width="332" alt="image-20251120-182735.png" /></span>

- Make sure that the grant files only contain your changes

<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img src="images/image-20251120-184011.png" class="confluence-embedded-image image-center" loading="lazy" data-image-src="images/image-20251120-184011.png" data-height="447" data-width="1948" data-unresolved-comment-count="0" data-linked-resource-id="2563244035" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20251120-184011.png" data-base-url="https://claviation.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="2561867784" data-linked-resource-container-version="9" data-media-id="79be0b33-4120-476d-badf-22ba454a7b4a" data-media-type="file" srcset="images/image-20251120-184011.png 2x, images/image-20251120-184011.png 1x" width="760" alt="image-20251120-184011.png" /></span>

- **Revert Changes to Filters file** `.dbtools/filters/project.filters` before committing in Git.

## 2.4. Stage Changes

You are ready to stage changes when the following actions have been completed:

- All changed database objects (tables, views, triggers, constraints, packages) have been exported

- All changed APEX applications have been exported

- All changed grants and privileges have been exported

- The following changes will be added AFTER Stage command:

  - Custom /DML Changes

  - ORDS Handlers Changes ( at least at the time of writing)

To do staging:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="48b0649e-2953-46d7-bc28-d6f2a0357eed" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
git add .
git commit -m 'ready to stage'
sql /nolog
conn -name proj_dev
proj stage 
```

</div>

</div>

Output on the process will look like the following. Please note the warnings ‚Äú**The hash value of the file user_role_privs.sql was incorrect and has been automatically adjusted**‚Äù . This is a result of our manual adjsutment of these files. It‚Äôs expected

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="269fec91-c9cc-412f-a906-133b196b99a8" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
SQL> proj stage

Stage is Comparing:
Old Branch      refs/heads/main
New Branch      refs/heads/erp_fix_apexdev

WARN: The following files were updated:
The hash value of the file user_role_privs.sql was incorrect and has been automatically adjusted
The hash value of the file user_sys_privs.sql was incorrect and has been automatically adjusted




Stage processesing completed, please review and commit your changes to repository
```

</div>

</div>

All information below ‚Äú**Stage processesing completed**‚Äù line is pretty much useless.

Review the changes in VS Code. Verify that you only have the changes that you made.

> Note: You may note changes to ‚ÄúORDS‚Äù that you did not make. **<span colorid="no15xs4zdz">This is another bug with SQLcl . </span>** You should get rid of these changes either by pressing ‚ÄúDisacard‚Äù button in VS Code or running Git Command
>
> <div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="621ea2a3-38f7-4a11-ad2b-a82d8bbc970c" macro-name="code" style="border-width: 1px;">
>
> <div class="codeContent panelContent pdl">
>
> ``` sql
> git restore --source=main --worktree --staged -- dist/releases/ords
> ```
>
> </div>
>
> </div>

<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img src="images/image-20251120-194322.png" class="confluence-embedded-image image-center" loading="lazy" data-image-src="images/image-20251120-194322.png" data-height="531" data-width="426" data-unresolved-comment-count="0" data-linked-resource-id="2563801089" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20251120-194322.png" data-base-url="https://claviation.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="2561867784" data-linked-resource-container-version="9" data-media-id="03b2f74c-fe1c-4410-aecf-114322cef480" data-media-type="file" srcset="images/image-20251120-194322.png 2x, images/image-20251120-194322.png 1x" width="426" alt="image-20251120-194322.png" /></span>

> **Note:** If you find it more convinient, you may run git commands from SQLcl using **!** syntax. However, in this case run `pwd` first to verify that SQLcl is in repo root folder
>
> <div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="39351dcd-3546-4727-9b50-c1b61b4bd1cd" macro-name="code" style="border-width: 1px;">
>
> <div class="codeContent panelContent pdl">
>
> ``` sql
> pwd
> !git add.
> ```
>
> </div>
>
> </div>

## 2.5. Add DML and Other Custom Changes

If you need to add DML or any other custom files to your feature, it‚Äôs time to do it now with ‚Äòstage add-custom‚Äô command.

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="4fe46c44-d10c-48a7-a70b-156bf90f7a00" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
 proj stage add-custom -file-name  test.sql
```

</div>

</div>

The most common custom changes:

1.  DML on ‚Äúfixed‚Äù tables, for example, insert 15 invoice statuses into INVOICE_STATUS table

2.  Handle objects that SQLcl project does not handle natively, for example:

    1.  Run Alter System

    2.  Create/Drop APEX Workspace

    3.  Create/Drop Scheduled Jobs, AQ Tables, Refresh Materialized Views

    4.  Stop/Start Jobs and APEX Automations

    5.  ‚Ä¶ and much more‚Ä¶

After running add-custom command above, open the file `dist/releases/next/changes/<your_branch>/_custom/test.sql` for edit and add your code after LB header, so for example it looks like this:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="969a5f87-7ecc-4d57-99cf-fb8a53235ff5" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
-- liquibase formatted sql
-- changeset  SqlCl:1763669390933 stripComments:false logicalFilePath:erp_fix_apexdev\_custom\test.sql
-- sqlcl_snapshot dist\releases\next\changes\erp_fix_apexdev\_custom\test.sql:null:null:custom



Prompt "Testing..."

begin
    null;
 end;
/
```

</div>

</div>

## 2.7. <span colorid="rlhb4fhgnv">Tricky</span>:Add ORDS Changes

SQLcl provides built-in inetrface to manage ORDs schema, **however this interface lacks granularity and deals with the entire schema.**

In reality, developers usually make changes to a module, test it and want to deploy this module only to production. Your development environment may include other multiple modules which are in WIP or POC state, so deploying the entire schema is very rare an option...

To incorporate deployment of ORDS module changes into your feature, follow the procedure and example available in the file `scripts/sql/deployment/deploy_ords_module.sql`:

1.  Create a custom script to export ORDS module definition

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="425fca9f-3fdf-4fda-93c9-d3ece2b2fbcb" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
proj stage add-custom -file-name ord_tracerp_module -- replace by your module name
```

</div>

</div>

2.  Run the script below as schema owner CLA_APEX or CLA_PUBLIC (NOT as CLA_DEPLOYER!!!!) to export ORDS module definition

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="e437e5ad-87b8-4c31-b71c-f4e6b8db1955" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
SELECT 
 REGEXP_REPLACE(
 ords_metadata.ords_export.export_module (
        p_module_name             => u.name,
        p_include_enable_schema   => false ,
        p_include_privs           => true ,
        p_privs_with_other_mod_refs   => true,
        p_export_date             => false
    ),
     'ORDS\.([^\(]*\()',
      'ORDS_ADMIN.\1
      p_schema => '''||user||''', ',
               1, 0, 'n'
    )||'
/
' stmt
  FROM USER_ORDS_MODULES u
  where u.name = 'claylacy.tacerp' --- specify your module name here
/
```

</div>

</div>

3.  APPEND the output to the file created in step 1

## 2.9. Split Statements in DDL File

**Another limitation of SQLcl is that it does not split ALTER TABLE and other table-related statements in a changeset file.**

For, example, if you have multiple changes in CLA_AIRCRAFT table, you file `dist/releases/next/changes/dev-02/cla_apex/tables/cla_aircraft.sql `

will look like this:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="35c768e5-408d-4a17-81bc-6e620990e96b" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql

 -- liquibase formatted sql 
-- sqlcl_snapshot src/database/cla_apex/tables/cla_aircraft.sql:08bee489420289da19c387e5b924e0e21acc0faa:f6b3abb88fff315ad9e845989ec24ed6b54d31a3:alter 
-- changeset CLA_APEX:1761764378736 stripComments:false logicalFilePath:dev-02\cla_apex\tables\cla_aircraft.sql 

alter table cla_apex.cla_aircraft 
drop (fl3xx_live); 

alter table cla_apex.cla_aircraft add ( 
adult_critical_care number(1, 0), 
aviapages_aircraft_id number, 
aviapages_aircraft_type_id number, 
year_of_production number 
); 

alter table cla_apex.cla_aircraft 
add constraint make_model_serial_uk2 unique (aviapages_aircraft_type_id, serial_number) 
using index enable; 

alter table cla_apex.cla_aircraft 
add constraint registration_uk1 unique (registration) 
using index enable;
```

</div>

</div>

This file should be manually edited to move each DDL statement in its own changeset, the resulting file should look like the following:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="fc6f55d8-3ad5-43cc-8121-cab7d0de8aa1" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
-- liquibase formatted sql 
-- sqlcl_snapshot src/database/cla_apex/tables/cla_aircraft.sql:08bee489420289da19c387e5b924e0e21acc0faa:f6b3abb88fff315ad9e845989ec24ed6b54d31a3:alter 

-- changeset CLA_APEX:1761764378736.1 stripComments:false logicalFilePath:dev-02\cla_apex\tables\cla_aircraft.sql 
alter table cla_apex.cla_aircraft 
drop (fl3xx_live); 

-- changeset CLA_APEX:1761764378736.2 stripComments:false logicalFilePath:dev-02\cla_apex\tables\cla_aircraft.sql 
alter table cla_apex.cla_aircraft add ( 
adult_critical_care number(1, 0), 
aviapages_aircraft_id number, 
aviapages_aircraft_type_id number, 
year_of_production number 
); 

-- changeset CLA_APEX:1761764378736.3 stripComments:false logicalFilePath:dev-02\cla_apex\tables\cla_aircraft.sql 
alter table cla_apex.cla_aircraft 
add constraint make_model_serial_uk2 unique (aviapages_aircraft_type_id, serial_number) 
using index enable; 

-- changeset CLA_APEX:1761764378736.4 stripComments:false logicalFilePath:dev-02\cla_apex\tables\cla_aircraft.sql 
alter table cla_apex.cla_aircraft 
add constraint registration_uk1 unique (registration) 
using index enable; 
```

</div>

</div>

I.e. one line

**-- changeset CLA_APEX:1761764378736 stripComments:false logicalFilePath:dev-02\cla_apex\tables\cla_aircraft.sql**

is replaced by four lines

**-- changeset CLA_APEX:1761764378736.<span colorid="o2lu74rx5c">\[1-4\]</span> stripComments:false logicalFilePath:dev-02\cla_apex\tables\cla_aircraft.sql**

That allows the installation process to become restartable regradless at what statement the process fails

##  2.8. <span colorid="r0rdhunfvg">Tricky:</span> Re-Staging

If you discovered that you need to do some changes to SRC ( for example, if you forgot to include an object, you need to change the package, or last minute in changing grands) you will have to do re-staging. **Unfortunately, SQLcl Project does a terrible job with incremental staging and re-staging.**

There are two situations:

1.  **You did not do too many manual changes to your feature in DIST**

In this case, the best option would be discarding chages under `dist` in Git and do `project stage`

For example, we granted above two new priveleges to CLA_APEX - Turns out it was a mistake. Now the privileges have been revoked in DEV and we need to update our feature branch:

- Fist, we restore grants files from main:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="4fac09fc-b446-4cb8-a95e-b61ee1b52de5" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
git restore --source=main --worktree --staged src/database/sys/object_grants/user_role_privs.sql
git restore --source=main --worktree --staged src/database/sys/object_grants/user_sys_privs.sql
```

</div>

</div>

- Now we fully discard changes in `dist`

> Notes: You may find more convinient to go it with VS Code Discard button

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="97f93d40-e99c-4132-9524-7da2336d4380" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
git restore --source=main --worktree --staged dist/releases/
git restore --staged dist/releases/
git clean -fd dist/releases/
```

</div>

</div>

- Now commit the reverted changes in SRC and stage again

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="c76c5ebc-16cb-4895-be8b-91650c09d7e8" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
!git commit -m 'removed wrong  grants'
conn -name proj_dev
proj stage
```

</div>

</div>

- As annoying as it is, fake ORDS changes are generated and need to be removed

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="f9234a7e-ae51-47ab-9c29-1c0ea710a21f" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
 git restore --source=main --worktree --staged -- dist/releases/ords
```

</div>

</div>

Now you have a clean updated dist folder which is ready for deployment

<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img src="images/image-20251121-191313.png" class="confluence-embedded-image image-center" loading="lazy" data-image-src="images/image-20251121-191313.png" data-height="415" data-width="1572" data-unresolved-comment-count="0" data-linked-resource-id="2565898246" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20251121-191313.png" data-base-url="https://claviation.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="2561867784" data-linked-resource-container-version="9" data-media-id="cfd86f4e-b273-49d7-b9fc-0b9fa3dbbea8" data-media-type="file" srcset="images/image-20251121-191313.png 2x, images/image-20251121-191313.png 1x" width="760" alt="image-20251121-191313.png" /></span>

2.  **You did sizable changes in DIST Folder**

Unfortunately, SQLcl Project does not do a good job here. If you want to re-stage after you have made significant changes, you need to follow these steps:

- Commit or at least stage in Git your current changes, so you can easily see the difference re-staging will introduce

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="3f0db90f-51f3-4a35-8d3a-7fc18e23a102" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
git add dist/
# Optionally
git commit -m "before re-staging"
```

</div>

</div>

- Run stage command again

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="1cf0fc91-b5d6-4879-8975-265a5457c18c" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
project stage
```

</div>

</div>

- In VS Code in Changes **<span colorid="y175eg2c97">very careful review all changed files and make case-by-case decision if you wan to:</span>**

  - Accept new changes

  - Discard new changes

  - Merge changes

- One of the files wich **always be** changed at re-staging is `dist/releases/next/changes/<feature>/stage.changelog.xml` **Always open this file in VS Code Changes view and analyse the differences.**

<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img src="images/image-20251121-192837.png" class="confluence-embedded-image image-center" loading="lazy" data-image-src="images/image-20251121-192837.png" data-height="266" data-width="2031" data-unresolved-comment-count="0" data-linked-resource-id="2565734405" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20251121-192837.png" data-base-url="https://claviation.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="2561867784" data-linked-resource-container-version="9" data-media-id="abbdf8f6-4e3c-4b4d-ab78-c101af9d7e12" data-media-type="file" srcset="images/image-20251121-192837.png 2x, images/image-20251121-192837.png 1x" width="760" alt="image-20251121-192837.png" /></span>

As you can see, in this example `project stage` just added the same files to this file twice. In this case, the changes to this file can simply be discarded; however, more often you would need to merge old and new changes in this file manually.

# 3. Test Deployment Scripts

To test deployment scripts you need to run them against VM database.

- You can discover multiple issues during deployment and may need to rerun it several times.

- If you ran into a problem you can fix it and continue. However, to verify your fix you should restore VM to a restore point and try to run entire script error free.

- Use Helper script `dist/install_vm.sql` to try your deployment on VM

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="362afb29-e0fc-42f1-8fce-bb1f9d818f47" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
cd . 
conn -name proj_vm

 prompt "Dropping restore point before installation if exists"
begin
    execute immediate 'drop restore point before_installation';
exception
    when others then
        if sqlcode != -1918 then
            raise;
        end if;
end;
/

prompt "Creating restore point before installation"
create restore point before_installation;

@install 
```

</div>

</div>

- To run the script, make sure you start from dist folder:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="22f3d0d9-25e2-4f54-8a5e-ee4c09383b36" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
cd dist
@dist/install_vm.sql
```

</div>

</div>

- If you have any erorrs, run the script `@install.sql` not `install_vm.sql`until you have a clean run install.

- If possible, connect to VM in SQL Developer, review and unit test your changes.

**When you are done with testing, reset VM to the restore point.Run** `scripts\sql\deployment\vm_flashback.sql`

**At this point you tested your deployment against the VM database and reset the VM to he state of the main branch.**

# 4. Submit and Merge PR

## 4.1. Submit PR

Now, you know that your code is deployable, it‚Äôs time to submit a PR and get reviewed and it approved by your peers!

To submit a PR:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="b47eaf6e-c0c4-450d-a837-732cfde78eea" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
git add .
git commit -m 'ready for review'
git push --set-upstream origin erp_fix_apexdev #replace with your branch name
```

</div>

</div>

Bitbucket will create a pull request for you and send you back a URL. Follow the URL:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="95a2e322-399e-407a-ab4a-049adc71d9a9" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
git push --set-upstream origin erp_fix_apexdev
Enumerating objects: 77, done.
Counting objects: 100% (77/77), done.
Delta compression using up to 16 threads
Compressing objects: 100% (43/43), done.
Writing objects: 100% (49/49), 32.48 KiB | 665.00 KiB/s, done.
Total 49 (delta 26), reused 0 (delta 0), pack-reused 0 (from 0)
remote: 
remote: Create pull request for erp_fix_apexdev:
remote:   https://bitbucket.org/cla-apex/cla-project/pull-requests/new?source=erp_fix_apexdev&t=1
remote:
To bitbucket.org:cla-apex/cla-project.git
 * [new branch]      erp_fix_apexdev -> erp_fix_apexdev
branch 'erp_fix_apexdev' set up to track 'origin/erp_fix_apexdev'.
```

</div>

</div>

In this case the url to follow was <a href="https://bitbucket.org/cla-apex/cla-project/pull-requests/new?source=erp_fix_apexdev&amp;t=1" class="external-link" rel="nofollow">https://bitbucket.org/cla-apex/cla-project/pull-requests/new?source=erp_fix_apexdev&amp;t=1</a>

> **Carefully review all the changes in bitbucket, make sure you understand every change. When done with the review:**
>
> 1.  **Click ‚ÄúCreate pull request‚Äù buton**
>
> 2.  Assing the reviewer

<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img src="images/image-20251121-201433.png" class="confluence-embedded-image image-center" loading="lazy" data-image-src="images/image-20251121-201433.png" data-height="825" data-width="1647" data-unresolved-comment-count="0" data-linked-resource-id="2566488068" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20251121-201433.png" data-base-url="https://claviation.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="2561867784" data-linked-resource-container-version="9" data-media-id="3d457d18-7a0e-49fe-ac12-7a9322fc087b" data-media-type="file" srcset="images/image-20251121-201433.png 2x, images/image-20251121-201433.png 1x" width="760" alt="image-20251121-201433.png" /></span>

## 4.2. Approve and Merge PR

Work with the reviewer to make sure the feature is approved and merged. To merge PR open it and click Merge button.

<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img src="images/image-20251121-202523.png" class="confluence-embedded-image image-center" loading="lazy" data-image-src="images/image-20251121-202523.png" data-height="673" data-width="1667" data-unresolved-comment-count="0" data-linked-resource-id="2565636108" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20251121-202523.png" data-base-url="https://claviation.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="2561867784" data-linked-resource-container-version="9" data-media-id="5cf610c9-d445-4e3c-8621-08ee19749d78" data-media-type="file" srcset="images/image-20251121-202523.png 2x, images/image-20251121-202523.png 1x" width="760" alt="image-20251121-202523.png" /></span>

## 4.3. Pull Main Branch

After PR is approved, it‚Äôs critical to switch branch to main and pull main before proceeding to all steps below

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="aff7b38b-0232-4534-b893-8418a94b3c8d" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
git checkout main 
git pull
```

</div>

</div>

# 5. <span colorid="rwxp6jio0d">Optional: </span>Build Deployment Articact

After the feature is merged, it‚Äôs ready to be deployed to TEST.

**<u>Optionally</u>** you can build an artifact to support the deployment.

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="ab016077-9fe9-4650-9428-da2afbf05a70" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
project gen-artifact -name erp_fix_apexdev  -version 25.3  -format zip -verbose
```

</div>

</div>

successfull command output will look the followinfg:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="40a18cd8-a94f-4eb7-b376-ed616f9a7c74" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
...

ile : C:\repo\cla-project\dist\sqlcl-lb-1763754424655.log
file : C:\repo\cla-project\dist\sqlcl-lb-1763754930069.log
file : C:\repo\cla-project\dist\utils\enable_automations.sql
file : C:\repo\cla-project\dist\utils\prechecks.sql
file : C:\repo\cla-project\dist\utils\recompile.sql
Your artifact has been generated erp_fix_apexdev-25.3.zip
```

</div>

</div>

> **Note**: Building atrifact is mandatory if deployment to Test is carried out by a DBA or CI/CD Pipeline process.
>
> In case the deployment is carried out by developer, the articact is not required.

# 6. Deploy to Test

## 6.1. Deployment By Developer ( No Artifact)

To deployment to test by the developer, it‚Äôs enoug to run the following command in SQLcl:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="ad0d17f4-c246-4591-8022-ef6361abd523" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
conn -name proj_test
show conn --- Verify  
pwd -- Veriy if current floder is dist. If not:
cd dist  
@install
```

</div>

</div>

During the deployment a log file `dist/sqlcl-lb-<some-id>log` will be generated and can be reviewed later for troubleshooting.

## 6.2. Deployment With Artifact

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="39bc8308-74dd-43fd-b880-9e4044581417" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
conn -name proj_test
project deploy -file artifact/erp_fix_apexdev-25.3.zip -verbose
```

</div>

</div>

> **Note:** If artifact has nothing to do, it fails with ugly Java error:
>
> <div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="b607baf9-07be-4d03-a93a-94604495d4ba" macro-name="code" style="border-width: 1px;">
>
> <div class="codeContent panelContent pdl">
>
> ``` sql
> tarting the migration...
> Installing/updating schemas
> --Starting Liquibase at 2025-11-21T16:06:36.141710600 using Java 17.0.13 (version 4.30.0 #0 built at 2025-04-01 10:24+0000)
> Running Changeset: dev-01/_custom/ams_config_dml.sql::1761249915279::SqlCl
>
> UPDATE SUMMARY
> Run:                          1
> Previously run:            2572
> Filtered out:                 0
> -------------------------------
> Total change sets:         2573
>
> Liquibase: Update has been successful. Rows affected: 0
>
> Null Pointer please log a bug.
> java.lang.NullPointerException: Cannot invoke "java.io.File.getName()" because the return value of "oracle.dbtools.raptor.liquibase.util.LbFileUtils.getLog()" is null
>         at oracle.dbtools.raptor.scriptrunner.commands.liquibase.LbCommand.write_success(LbCommand.java:475)
>         at oracle.dbtools.raptor.scriptrunner.commands.liquibase.LbCommand.handleEvent(LbCommand.java:382)
>         at oracle.dbtools.raptor.newscriptrunner.CommandRegistry.fireListeners(CommandRegistry.java:454)
>         at oracle.dbtools.raptor.newscriptrunner.ScriptRunner.lambda$run$0(ScriptRunner.java:241)
>         at oracle.dbtools.raptor.newscriptrunner.ScriptRunnerContext.runWithStoredContext(ScriptRunnerContext.java:837) 
> ```
>
> </div>
>
> </div>

# 7. Conduct UAT

Well, this is up to the cleint <img src="/wiki/s/1959204496/6452/ccfc3f785872aeebcd78e1f523c7082575bbd768/_/images/icons/emoticons/smile.png" class="emoticon emoticon-smile" data-emoji-id="1f642" data-emoji-shortname=":slight_smile:" data-emoji-fallback="üôÇ" data-emoticon-name="smile" width="16" height="16" alt="(smile)" />

**Important:** If issues are found during UAT testing, at your discreptrion:

- You can start a new branch in Git ( **Highly recommended in most cases !!!!)**

- Check out current feature branch and continue to working( Only recommended for small changes like adding a custom file or rebuilding a package)

In either afer a UAT fix is apprived and tested in TEST, merge changes to main.

If you have fixed UAT issue in test, please backfill Dev ( see <a href="/wiki/spaces/OA/pages/2562097153/5.+Hot+Fix+Deployment" data-linked-resource-id="2562097153" data-linked-resource-version="3" data-linked-resource-type="page">https://claviation.atlassian.net/wiki/spaces/OA/pages/2562097153/5.+Hot+Fix+Deployment</a> for details )

# 8. Build a Release

- Release is built when all changes that need to go to Prod have passed UAT in Test

- There are NO changes in Test ( and merged into the main branch that are currently undergoing testing)

To build a release ( Replace 25.3. by your release number):

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="8c2abc9b-a48e-4927-bf70-058077276be1" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
conn -name proj_test --- Can be also dev, prod, or vm, goes not matter 
git checkout main
git pull
--- you can build release in main to save time, it's OK...

proj release -version 25.3 -v

git add .
git commit -m 'release 25.3'
git tag  25.3
git push
```

</div>

</div>

# 9. Deploy to Prod

## 9.1. Avoid Surprises

To avoid any surprises, what would be run in Production, before proceeding with a real update, **always** run `LB STATUS`:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="bc40b6ab-f803-4b33-8fc7-1cc9d9f4825a" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
conn -name proj_prod
lb status  -changelog-file releases/main.changelog.xml
```

</div>

</div>

It produces the following output:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="cf3cf65e-2bd6-416b-9e50-00f210baa063" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
SQL> lb status  -changelog-file releases/main.changelog.xml
--Starting Liquibase at 2025-11-21T16:38:05.487693200 using Java 17.0.13 (version 4.30.0 #0 built at 2025-04-01 10:24+0000)
4 changesets have not been applied to CLA_DEPLOYER@jdbc:oracle:thin:@//10.194.2.167:1521/pdb01.privsubnet2reg.vcnclaylacy01.oraclevcn.com
     dev-01/_custom/ams_config_dml.sql::1761249915279::SqlCl
     erp_fix_apexdev/cla_apex/package_specs/erp_emergency_event_util.sql::1763752587080::CLA_APEX
     erp_fix_apexdev/cla_apex/package_bodies/erp_emergency_event_util.sql::1763752586636::CLA_APEX
     releases/apex/f110/f110.xml::INSTALL_110::SQLCL-Generated


Operation completed successfully.
```

</div>

</div>

Make sure you recognize all changes ( and the most important - all APEX apps that are going to be deployed)

## 9.2. Identify Production Drift

Follow <a href="https://claviation.atlassian.net/wiki/spaces/OA/pages/2561638402/6.+Mitigating+Production+Drift?atlOrigin=eyJpIjoiZDljMjc4OTEzNWE0NDgyMmIyOTdiYTc0OGNlMGY5OTUiLCJwIjoiYyJ9" rel="nofollow">https://claviation.atlassian.net/wiki/spaces/OA/pages/2561638402/6.+Mitigating+Production+Drift?atlOrigin=eyJpIjoiZDljMjc4OTEzNWE0NDgyMmIyOTdiYTc0OGNlMGY5OTUiLCJwIjoiYyJ9</a> to identify any drift in objects you are about to deploy

## 9.3. GO!

Follow the same procedures as for <a href="https://claviation.atlassian.net/wiki/spaces/OA/pages/edit-v2/2561867784#6.-Deploy-to-Test" rel="nofollow">https://claviation.atlassian.net/wiki/spaces/OA/pages/edit-v2/2561867784#6.-Deploy-to-Test</a>

# 10. Taking Care of Unexpected

Even a perfectly tested deployment sometimes fails in Production. There are two strategies to deal with that:

1.  If your system supports it, incorporate into your deployment ( or run before your deployment) a `CREATE RESTORE POINT` command:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="2e2bff65-6f3a-4d54-80f9-0b693dc55454" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
create restore point before_installation;
```

</div>

</div>

If deployment fails, you may ask a DBA to flashback your database ot this restore point:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="d7dc6a47-bd0f-4ff1-81d4-67f3a144288e" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
FLASHBACK PLUGGABLE DATABASE FREEPDB1 TO RESTORE POINT TEST
```

</div>

</div>

> Note: Fleashback Pluggable Database feature is not supported in Oracle Standard

2.  If you do not have the flashback option, you will need to finish deployment, otherwise your system will be in an inconsistent state.

- In case of changeset failing, investigate and eliminate the root cause. For example, if you fail to create a unique constratint, delete duplicate records and rerun the installation

- In you are trying to create a unique constraint that already exists, run the following command to mark the last failed changeset as ‚ÄúRUN‚Äù and proceed with installation.

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="86d044d0-ba01-4f7b-8acb-99a6a6ed5077" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
liquibase mark-next-changeset-ran -changelog-file releases/main.changelog.xml 
```

</div>

</div>
