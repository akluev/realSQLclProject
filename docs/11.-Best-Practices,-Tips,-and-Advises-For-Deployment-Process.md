- [1. Use Secrets and Environment-Specific Parameters](#1-use-secrets-and-environment-specific-parameters)
  - [Use ${VAR\_NAME} syntax](#use-var_name-syntax)
  - [Setting Environment Variables](#setting-environment-variables)
    - [Unix / Linux / macOS](#unix--linux--macos)
    - [Windows PowerShell](#windows-powershell)
    - [Windows CMD](#windows-cmd)
  - [⚠ Important Warning](#-important-warning)
  - [Validating Environment Variables in Changesets (Best Practice)](#validating-environment-variables-in-changesets-best-practice)
- [2. Working with Multi-DDL-Statatements Changesets](#2-working-with-multi-ddl-statatements-changesets)
- [3. Delete APEX App in SRC Before Export](#3-delete-apex-app-in-src-before-export)
- [4. Re-Enabling Automations and REST Syncs After the Install](#4-re-enabling-automations-and-rest-syncs-after-the-install)
- [5. Getting Rid of Fake ORDS Changes](#5-getting-rid-of-fake-ords-changes)
- [6. Artifact Deployment Fails with Java Error when the Artifact Generates No Changes](#6-artifact-deployment-fails-with-java-error-when-the-artifact-generates-no-changes)
- [7. Run LB Status before Prod Deployment To Avoid Surprises](#7-run-lb-status-before-prod-deployment-to-avoid-surprises)
- [8. APEX Apps Manual Backup](#8-apex-apps-manual-backup)


# 1. Use Secrets and Environment-Specific Parameters



SQLcl Project substitutes **OS-level environment variables** during deployment.  
These variables **must be defined in the operating system**, not inside SQLcl or SQL scripts.

## Use \${VAR_NAME} syntax

``` sql
begin
   cla_apex.cla_configuration_pkg.upsert (
        p_instance_id =>1 ,
        p_key_type_id => 1,
        p_key         => 'ams_server',
        p_description => 'Local AMS (APEX Messaging Service) server URL',
        p_value       => 'https://${AMS_SERVER_FQDN}',
        p_key_group   => 'ams'
    );  
end;
/
```


If a variable is **missing**, SQLcl Project **does not fail** — instead, it inserts the literal placeholder:

```
'${AMS_SERVER_FQDN}'
```

This can silently corrupt configuration values across DEV/TEST/PROD.

---

## Setting Environment Variables

### Unix / Linux / macOS
```bash
export AMS_SERVER_FQDN='127.0.0.1'
export API_KEY='abc123'
```

### Windows PowerShell
```powershell
$env:AMS_SERVER_FQDN = "127.0.0.1"
$env:API_KEY = "abc123"
```

### Windows CMD
```cmd
set AMS_SERVER_FQDN=127.0.0.1
set API_KEY=abc123
```

These must be set **on the machine that runs the deployment**.

---

## ⚠ Important Warning

SQLcl Project **will NOT throw an error** if a required variable is missing.

It simply writes the literal text `${VAR_NAME}` into the database.

---

## Validating Environment Variables in Changesets (Best Practice)

Use Liquibase preconditions to ensure variables are set:

```sql
--preconditions onFail:CONTINUE
--precondition-sql-check expectedResult:0     SELECT count(*)    FROM dual    WHERE '${AMS_SERVER_FQDN}' = '$'||'{'||'AMS_SERVER_FQDN'||'}'
```

**Behavior:**
- Missing variable → condition TRUE → **changeset skipped**  
- Valid variable → condition FALSE → **changeset runs**


# 2. Working with Multi-DDL-Statatements Changesets

A file with multiple DDL statements should be manually edited to move each DDL statement in its own changeset, the resulting file should look like the following:

``` sql
-- liquibase formatted sql 
-- sqlcl_snapshot src/database/cla_apex/tables/cla_aircraft.sql:08bee489420289da19c387e5b924e0e21acc0faa:f6b3abb88fff315ad9e845989ec24ed6b54d31a3:alter 

-- changeset CLA_APEX:1761764378736.1 stripComments:false logicalFilePath:dev-02\cla_apex\tables\cla_aircraft.sql 
alter table cla_apex.cla_aircraft 
drop (fl3xx_live); 

-- changeset CLA_APEX:1761764378736.2 stripComments:false logicalFilePath:dev-02\cla_apex\tables\cla_aircraft.sql 
alter table cla_apex.cla_aircraft add ( 
adult_critical_care number(1, 0), 
aviapages_aircraft_id number, 
aviapages_aircraft_type_id number, 
year_of_production number 
); 

-- changeset CLA_APEX:1761764378736.3 stripComments:false logicalFilePath:dev-02\cla_apex\tables\cla_aircraft.sql 
alter table cla_apex.cla_aircraft 
add constraint make_model_serial_uk2 unique (aviapages_aircraft_type_id, serial_number) 
using index enable; 

-- changeset CLA_APEX:1761764378736.4 stripComments:false logicalFilePath:dev-02\cla_apex\tables\cla_aircraft.sql 
alter table cla_apex.cla_aircraft 
add constraint registration_uk1 unique (registration) 
using index enable; 
```

That allows the installation process to become restartable regradless at what statement the process fails

# 3. Delete APEX App in SRC Before Export


It’s important to DELETE APEX application files in ‘src’ before exporting, otherwise you may **not** see which pages and shared components where deleted until it’s too late…


``` sql
!rm -fR src/database/cla_apex/apex_apps/f110
 proj export -o APEX.110
```


# 4. Re-Enabling Automations and REST Syncs After the Install

>APEX 24.2.has a very annoying bug that all scheduled automations and REST sycns become disabled after the import.

If you added in your feature a new active scheduled Automation or REST Sync, make sure you added a reference to it into `@dist/utils/enable_automations.sql` file into your `install.sql`. You will need to customize `dist/utils/enable_automations.sql` for your project specific needs.


# 5. Getting Rid of Fake ORDS Changes

As another very annoying bug in SQLcl Project ORDS changes are generated even when there are no changes to ORDS metadata. It may create unnecessary merge conflicts and confusion.

To rectify that after `project stage` command run the following ( unless your fetaure indeed has changes to ORDS and you want to import entire ORDS schema)


``` sql
git restore --source=main --worktree --staged -- dist/releases/ords
```


# 6. Artifact Deployment Fails with Java Error when the Artifact Generates No Changes

Looks like sometimes the atricact for whatever reason cannot create a log and fails with an error like on below.

It can be safely ignored

<div class="code panel pdl conf-macro output-block" hasbody="true" local-id="a005a698-429f-4839-a9a7-9f7443a3f986" macro-id="d188f086-4aef-461b-8b7a-da2dfb2f4191" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

```
Starting the migration...
Installing/updating schemas
--Starting Liquibase at 2025-11-21T16:06:36.141710600 using Java 17.0.13 (version 4.30.0 #0 built at 2025-04-01 10:24+0000)
Running Changeset: dev-01/_custom/ams_config_dml.sql::1761249915279::SqlCl

UPDATE SUMMARY
Run:                          1
Previously run:            2572
Filtered out:                 0
-------------------------------
Total change sets:         2573

Liquibase: Update has been successful. Rows affected: 0

Null Pointer please log a bug.
java.lang.NullPointerException: Cannot invoke "java.io.File.getName()" because the return value of "oracle.dbtools.raptor.liquibase.util.LbFileUtils.getLog()" is null
        at oracle.dbtools.raptor.scriptrunner.commands.liquibase.LbCommand.write_success(LbCommand.java:475)
        at oracle.dbtools.raptor.scriptrunner.commands.liquibase.LbCommand.handleEvent(LbCommand.java:382)
        at oracle.dbtools.raptor.newscriptrunner.CommandRegistry.fireListeners(CommandRegistry.java:454)
        at oracle.dbtools.raptor.newscriptrunner.ScriptRunner.lambda$run$0(ScriptRunner.java:241)
        at oracle.dbtools.raptor.newscriptrunner.ScriptRunnerContext.runWithStoredContext(ScriptRunnerContext.java:837)
```


# 7. Run LB Status before Prod Deployment To Avoid Surprises

To avoid any surprises, what would be run in Production, before proceeding with a real update, **always** run `LB STATUS`:


``` sql
conn -name proj_prod
lb status  -changelog-file releases/main.changelog.xml
```


This command shows what changesets would be run by the next **LB update**

It produces the following output:


```
SQL> lb status  -changelog-file releases/main.changelog.xml
--Starting Liquibase at 2025-11-21T16:38:05.487693200 using Java 17.0.13 (version 4.30.0 #0 built at 2025-04-01 10:24+0000)
4 changesets have not been applied to CLA_DEPLOYER@jdbc:oracle:thin:@//10.194.2.167:1521/pdb01.privsubnet2reg.vcnclaylacy01.oraclevcn.com
     dev-01/_custom/ams_config_dml.sql::1761249915279::SqlCl
     erp_fix_apexdev/cla_apex/package_specs/erp_emergency_event_util.sql::1763752587080::CLA_APEX
     erp_fix_apexdev/cla_apex/package_bodies/erp_emergency_event_util.sql::1763752586636::CLA_APEX
     releases/apex/f110/f110.xml::INSTALL_110::SQLCL-Generated


Operation completed successfully.
```


Make sure you recognize all changes ( and the most important - all APEX apps that are going to be deployed)

# 8. APEX Apps Manual Backup

For backfills and hotfixes, you sometimes need to back up the apps in the target environment. Here is a small helper script for that. It exports app X and imports it as 1000+X:


``` sql
--- Backup APEX apps under app ID +1000

set define on
set verify off
set feedback on
---set echo on

cd .

accept p_app_id prompt 'Enter Application ID to backup: '

! mkdir "tmp/backup"

apex export -applicationid &p_app_id. -dir tmp/backup 

set define on
prompt 'Backup completed. File located at tmp/backup/f&p_app_id..sql'

begin
   apex_application_install.set_application_id(1000+to_number(&p_app_id.)); 
   APEX_APPLICATION_INSTALL.GENERATE_OFFSET;
 end;
/ 

set feedback off
set echo off

@tmp/backup/f&p_app_id..sql 
prompt 'Application &p_app_id. imported as 1&p_app_id.'
```


The script is located at `scripts/sql/deployment/backup_apps.sql`
