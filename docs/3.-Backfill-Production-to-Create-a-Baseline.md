

In the previous step <a href="https://insumsolutions.atlassian.net/wiki/spaces/CD/pages/138772483" class="external-link" rel="nofollow">https://insumsolutions.atlassian.net/wiki/spaces/CD/pages/138772483/Build+The+Main+Branch</a> , we have created a snapshot of production metadata in the src folder and the dist folder to install it. This installation will need to be run in VM and other environments that will need to build the system from scratch. **However, it should never run in TEST and PROD , where all these objects already exist.**

To solve this problem, we will use the Liquibase changelog-sync command. When run against the destination environment, the command analyzes the corresponding change log file and populates the LB control tables accordingly. This will inform subsequent LB UPDATE runs that the baseline changes have already been installed.

> **Note:** This step must be perfoemed before merging and new changes into MAIN

Here are the key steps of implementing this critical task:

1.  Create a new branch called baseline. This branch will never be merged back to main and may be safely dropped after the backfill is completed in Prod

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="d04a6efa-78c4-468a-b377-cbf2f19d1f17" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
git checkout main
git checkout -b baseline
```

</div>

</div>

2.  **IF you have direct access to PROD as CLA_DEPLOYER, just run the following commands in SQcl**

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="0955e5f6-a2ec-448e-b062-be10fd4193fb" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
conn -name proj_prod
cd dist
lb changelog-sync -changelog-file releases/main.changelog.xml 
```

</div>

</div>

3.  **IF you need to ask a DBA or another resource without access to repo run it for you, follow the steps below:**

4.  Edit `dist/install.sql` . Comment out `lb update` and add `lb changelog-sync` so it looks like this:

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="01da23d6-9253-47d1-a4b0-98e791cc6505" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
prompt "Running Liquibase changelog sync to mark changes as applied"
--lb update -log -debug -changelog-file releases/main.changelog.xml -search-path "."
lb changelog-sync -changelog-file releases/main.changelog.xml 
```

</div>

</div>

5.  Generate an artifact. The command below will generate file `artifact/baseline-25.1.zip`

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="5048c5aa-b968-44db-a48e-321a222175ee" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
project gen-artifact -name baseline  -version 25.1  -format zip -verbose
```

</div>

</div>

6.  Test the articact against VM database. If required, reset VM database first

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="aafc0582-1b31-4f82-80c8-d6d7668c8d6e" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
conn -name proj_vm
project deploy -file artifact/baseline-25.1.zip -verbose
```

</div>

</div>

7.  Check if the output is similar to the following and contains no errors

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="bf1e0c33-da9c-4937-9ffa-5f12017732ff" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
SQL> project deploy -file artifact/baseline-25.1.zip -verbose 
Check database connection...
Extract the file name: baseline-25.1
Artifact decompression in progress...
Artifact decompressed: C:\Users\ALEXAN~1\AppData\Local\Temp\bd1d4ced-6ac8-41c2-995e-298784cd33494729888322982759787
Starting the migration...
Running Liquibase changelog sync to mark changes as applied
--Starting Liquibase at 2025-10-29T09:28:01.892906600 using Java 17.0.13 (version 4.30.0 #0 built at 2025-04-01 10:24+0000)


Operation completed successfully.

Invalid object counts (INVALID status only):

PL/SQL procedure successfully completed.



Compiling invalid objects...


Invalid object counts after recompilation (INVALID status + synonyms with missing targets):


Invalid objects:


0 rows selected.


Compilation errors:


0 rows selected.


Other compilation errors not listed
___________________________________
                                  0

Log file(s) location: C:\repo\cla-project
Removing the decompressed artifact: C:\Users\ALEXAN~1\AppData\Local\Temp\bd1d4ced-6ac8-41c2-995e-298784cd33494729888322982759787...
```

</div>

</div>

8.  Check if in VM database table CLA_DEPLOYER.DATABASECHANGELOG exists and is populated, but no project users are created

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="7824be88-8bd6-45ff-9448-dd28aed7f06b" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
select count (*) from CLA_DEPLOYER.DATABASECHANGELOG;

COUNT(*)
________
    2229

SQL> select username  from DBA_USERS where username like 'CLA%';

USERNAME     
____________
CLA_DEPLOYER
    
```

</div>

</div>

9.  **Now, you are ready to pass** `artifact/baseline-25.1.zip` **to a DBA. Ask them to connect to Prod as CLA_DEPLOYER and run the deployment**

<div class="code panel pdl conf-macro output-block" hasbody="true" macro-id="08e959ff-c13a-42c3-b65d-86034ab2eb06" macro-name="code" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` sql
conn -name proj_prod
project deploy -file baseline-25.1.zip -verbose
```

</div>

</div>

> **Note:** Baseline Zip file can be downloaded from this page

<span class="confluence-embedded-file-wrapper conf-macro output-inline" hasbody="false" macro-id="3f18f1b5-3b72-4eca-8831-27fdc5abef64" macro-name="view-file"><a href="/wiki/download/attachments/2561867777/baseline-25.1.zip?version=1&amp;modificationDate=1763655961672&amp;cacheVersion=1&amp;api=v2" class="confluence-embedded-file" data-nice-type="Zip Archive" data-file-src="/wiki/download/attachments/2561867777/baseline-25.1.zip?version=1&amp;modificationDate=1763655961672&amp;cacheVersion=1&amp;api=v2" data-linked-resource-id="2561900549" data-linked-resource-type="attachment" data-linked-resource-container-id="2561867777" data-linked-resource-default-alias="baseline-25.1.zip" data-mime-type="application/zip" data-has-thumbnail="true" data-linked-resource-version="1" data-media-id="3c631ba8-af9e-47fa-9af9-5a2f4b544d99" data-media-type="file"><embed src="https://claviation.atlassian.net/wiki/download/thumbnails/2561867777/baseline-25.1.zip?version=1&amp;modificationDate=1763655961672&amp;cacheVersion=1&amp;api=v2&amp;viewType=fileMacro" height="250" /></a></span>
